<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>文件阅读器</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: Arial;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            /* 顶部区域 */
            .header {
                display: flex;
                border-bottom: 1px solid #ddd;
                padding: 10px;
                min-height: 60px;
                background: #f8f9fa;
            }

            .app-title {
                flex: 0 0 200px;
                font-size: 1.5rem;
                font-weight: bold;
                display: flex;
                align-items: center;
                padding-left: 10px;
            }

            .control-panel {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
                padding: 5px 0;
            }

            .file-input-label {
                padding: 8px 15px;
                background: #4285f4;
                color: white;
                border-radius: 4px;
                cursor: pointer;
                white-space: nowrap;
            }

            #file-input {
                display: none;
            }

            .search-box {
                flex: 1;
                min-width: 200px;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

            .nav-btn {
                padding: 8px 12px;
                background: #f1f1f1;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
            }

            /* 主内容区 */
            .main-content {
                display: flex;
                flex: 1;
                overflow: hidden;
                position: relative;
            }

            .panel {
                overflow: auto;
                padding: 10px;
                position: relative;
                border-right: 1px solid #ddd;
            }

            .file-list-panel {
                flex: 0 0 250px;
                min-width: 150px;
                resize: horizontal;
                overflow-x: hidden;
            }

            .content-panel {
                flex: 1;
                min-width: 200px;
                white-space: pre-wrap;
                resize: horizontal;
                background: #fff;
            }

            .result-panel {
                flex: 0 0 300px;
                min-width: 200px;
                resize: horizontal;
                background: #f8f9fa;
            }

            /* 文件列表项 */
            .file-item {
                padding: 8px 10px;
                margin: 5px 0;
                cursor: pointer;
                border-radius: 4px;
                word-break: break-all;
            }

            .file-item:hover {
                background: #e9ecef;
            }

            .file-item.active {
                background: #e7f1ff;
            }

            /* 搜索结果 */
            .result-group {
                margin-bottom: 15px;
            }

            .result-header {
                display: flex;
                justify-content: space-between;
                padding: 8px;
                background: #e9ecef;
                border-radius: 4px;
                cursor: pointer;
                align-items: center;
            }

            .result-content {
                padding: 5px 0;
                display: none;
                border-left: 2px solid #dee2e6;
                margin-left: 10px;
            }

            .match-item {
                padding: 8px;
                margin: 5px 0;
                cursor: pointer;
                border-radius: 4px;
            }

            .match-item:hover {
                background: #e9ecef;
            }

            .highlight {
                background: #fff3cd;
                padding: 0 2px;
            }

            /* 响应式设计 */
            @media (max-width: 768px) {
                .main-content {
                    flex-direction: column;
                }

                .panel {
                    flex: none;
                    width: 100% !important;
                    resize: none;
                    border-right: none;
                    border-bottom: 1px solid #ddd;
                }

                .control-panel {
                    gap: 5px;
                }

                .app-title {
                    flex: 0 0 auto;
                    font-size: 1.2rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="app-title">文件阅读器</div>
            <div class="control-panel">
                <label class="file-input-label" for="file-input">选择文件</label>
                <input type="file" id="file-input" multiple accept=".txt,.js,.css,.md,.json,.html,.xml,.csv,.java,.py,.php,.sh">
                <input type="text" class="search-box" id="search-input" placeholder="输入搜索内容...">
                <button class="nav-btn" id="search-btn">搜索</button>
                <button class="nav-btn" id="prev-btn">上一个</button>
                <button class="nav-btn" id="next-btn">下一个</button>
            </div>
        </div>
        <div class="main-content">
            <div class="panel file-list-panel" id="file-list-container"></div>
            <div class="panel content-panel" id="content-display"></div>
            <div class="panel result-panel" id="result-container"></div>
        </div>
        <script>
            // 全局变量
            const fileInput = document.getElementById('file-input');
            const fileListContainer = document.getElementById('file-list-container');
            const contentDisplay = document.getElementById('content-display');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const resultContainer = document.getElementById('result-container');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            let files = [];
            let currentFileIndex = -1;
            let searchResults = {};
            let currentMatch = {
                fileIndex: -1,
                matchIndex: -1
            };

            // 事件监听
            fileInput.addEventListener('change', handleFileSelect);
            searchBtn.addEventListener('click', performSearch);
            prevBtn.addEventListener('click', () => navigateMatch(-1));
            nextBtn.addEventListener('click', () => navigateMatch(1));

            // 文件选择处理
            function handleFileSelect(e) {
                const newFiles = Array.from(e.target.files);
                files = [...files, ...newFiles];
                renderFileList();
                if (files.length > 0 && currentFileIndex === -1) {
                    displayFileContent(0);
                }
            }

            // 渲染文件列表
            function renderFileList() {
                fileListContainer.innerHTML = '';
                files.forEach( (file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = `file-item ${index === currentFileIndex ? 'active' : ''}`;
                    fileItem.textContent = file.name;
                    fileItem.addEventListener('click', () => displayFileContent(index));
                    fileListContainer.appendChild(fileItem);
                }
                );
            }

            // 显示文件内容
            function displayFileContent(index) {
                currentFileIndex = index;
                const file = files[index];
                const reader = new FileReader();

                reader.onload = function(e) {
                    contentDisplay.textContent = e.target.result;
                    updateActiveFileStyle();
                    if (searchInput.value.trim()) {
                        highlightMatchesInCurrentFile();
                    }
                }
                ;

                reader.readAsText(file);
            }

            // 更新活动文件样式
            function updateActiveFileStyle() {
                document.querySelectorAll('.file-item').forEach( (item, index) => {
                    item.classList.toggle('active', index === currentFileIndex);
                }
                );
            }

            // 执行搜索
            function performSearch() {
                const searchTerm = searchInput.value.trim();
                if (!searchTerm)
                    return;

                searchResults = {};
                resultContainer.innerHTML = '';

                files.forEach( (file, fileIndex) => {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const content = e.target.result;
                        const regex = new RegExp(escapeRegExp(searchTerm),'gi');
                        let match;
                        const matches = [];

                        while ((match = regex.exec(content)) !== null) {
                            matches.push({
                                index: match.index,
                                length: match[0].length,
                                context: getMatchContext(content, match.index, match[0].length)
                            });
                        }

                        if (matches.length > 0) {
                            searchResults[fileIndex] = matches;
                            renderSearchResult(file, fileIndex, matches);
                        }
                    }
                    ;

                    reader.readAsText(file);
                }
                );
            }

            // 渲染搜索结果
            function renderSearchResult(file, fileIndex, matches) {
                const resultGroup = document.createElement('div');
                resultGroup.className = 'result-group';

                const resultHeader = document.createElement('div');
                resultHeader.className = 'result-header';
                resultHeader.innerHTML = `
                <span>${file.name} (${matches.length}处匹配)</span>
                <span>▶</span>
            `;

                const resultContent = document.createElement('div');
                resultContent.className = 'result-content';

                matches.forEach( (match, matchIndex) => {
                    const matchItem = document.createElement('div');
                    matchItem.className = 'match-item';
                    matchItem.innerHTML = `...${highlightMatch(match.context, searchInput.value)}...`;
                    matchItem.addEventListener('click', () => {
                        displayFileContent(fileIndex);
                        scrollToMatch(fileIndex, matchIndex);
                    }
                    );
                    resultContent.appendChild(matchItem);
                }
                );

                resultHeader.addEventListener('click', () => {
                    const isHidden = resultContent.style.display !== 'block';
                    resultContent.style.display = isHidden ? 'block' : 'none';
                    resultHeader.querySelector('span:last-child').textContent = isHidden ? '▼' : '▶';
                }
                );

                resultGroup.appendChild(resultHeader);
                resultGroup.appendChild(resultContent);
                resultContainer.appendChild(resultGroup);

                // 默认展开第一个结果组
                if (Object.keys(searchResults).length === 1) {
                    resultHeader.click();
                }
            }

            // 高亮当前文件中的匹配项
            function highlightMatchesInCurrentFile() {
                if (currentFileIndex === -1 || !searchResults[currentFileIndex])
                    return;

                const content = contentDisplay.textContent;
                const matches = searchResults[currentFileIndex];
                let highlightedContent = '';
                let lastIndex = 0;

                matches.forEach(match => {
                    highlightedContent += content.substring(lastIndex, match.index);
                    highlightedContent += `<span class="highlight">${content.substring(match.index, match.index + match.length)}</span>`;
                    lastIndex = match.index + match.length;
                }
                );

                highlightedContent += content.substring(lastIndex);
                contentDisplay.innerHTML = highlightedContent;
            }

            // 导航匹配项
            function navigateMatch(direction) {
                if (currentFileIndex === -1 || !searchResults[currentFileIndex])
                    return;

                const matches = searchResults[currentFileIndex];
                let newIndex = currentMatch.matchIndex + direction;

                if (newIndex < 0) {
                    newIndex = matches.length - 1;
                } else if (newIndex >= matches.length) {
                    newIndex = 0;
                }

                scrollToMatch(currentFileIndex, newIndex);
            }

            // 滚动到匹配项
            function scrollToMatch(fileIndex, matchIndex) {
                if (fileIndex !== currentFileIndex) {
                    displayFileContent(fileIndex);
                }

                currentMatch = {
                    fileIndex,
                    matchIndex
                };
                const match = searchResults[fileIndex][matchIndex];
                const highlighted = contentDisplay.querySelectorAll('.highlight');

                if (highlighted.length > matchIndex) {
                    highlighted[matchIndex].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }

            // 辅助函数
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function getMatchContext(text, index, length) {
                const start = Math.max(0, index - 20);
                const end = Math.min(text.length, index + length + 20);
                return text.substring(start, end);
            }

            function highlightMatch(text, term) {
                const regex = new RegExp(escapeRegExp(term),'gi');
                return text.replace(regex, match => `<span class="highlight">${match}</span>`);
            }
        </script>
    </body>
</html>
